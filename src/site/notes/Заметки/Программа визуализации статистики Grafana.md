---
{"dg-publish":true,"permalink":"/zametki/programma-vizualizaczii-statistiki-grafana/","created":"2024-07-04 00:36","updated":"2024-09-22T15:53:53+03:00"}
---

Программа с открытым исходным кодом для организации дашбордов и уведомлений по результатам мониторинга компьютерных систем. Имеет очень гибкую настройку выводимых данных и может использоваться с большим количеством различных баз данных. Сама по себе не является базой данных и предназначена только для вывода и анализа.

Официальный сайт: [Grafana: The open observability platform | Grafana Labs](https://grafana.com/)

Репозиторий: [GitHub - grafana/grafana: The open and composable observability and data visualization platform. Visualize metrics, logs, and traces from multiple sources like Prometheus, Loki, Elasticsearch, InfluxDB, Postgres and many more.](https://github.com/grafana/grafana)

Для запуска можно воспользоваться docker compose стеком  [[Хобби/Docker compose/Monitoring\|Monitoring]]
## Настройка уведомлений:

Основным преимуществом настройки уведомлений из Grafana является агрегация нескольких источников данных. Можно построить запрос и уведомления агрегируя сразу данные из [[Заметки/База данных мониторинга и статистики InfluxDB\|InfluxDB]] и [[Заметки/Система мониторинга Prometheus\|Prometheus]]. 

Основным минусом является достаточно сложная и путанная настройка уведомлений и не очень понятная документация.

При создании уведомлений можно применять шаблоны составленные по [[Заметки/Работа с шаблонами Grafana Alert\|правилам]].
### Основной порядок настройки уведомлений:

1. Создание события уведомления `Alert rule`. Событие может быть создано из панели или напрямую в интерфейсе.
2. Задать название событию.
![Программа визуализации статистики Grafana-2.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0%20%D0%B2%D0%B8%D0%B7%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20Grafana-2.png)
3. Добавить запрос данных из источника. Если была выбрана конкретная панель для создания используются запрос из панели (надо скорректировать отборы).
![Программа визуализации статистики Grafana-3.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0%20%D0%B2%D0%B8%D0%B7%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20Grafana-3.png)
> [!bug] Ограничение
> Судя по всему нет возможности на прямую соединить два разных запроса из разных источников в пост обработке.
5. Настройка пост обработки. Не обязательно можно сразу использовать результат запроса.
	1. Блок `Reduce` используется для сокращения запроса до одного значения на ряд.
	2. Блок `Threshold` устанавливает правила по которым формируется уведомления например значение больше N.
6. Установить источник уведомления. У одного из блоков должно быть прожато `Set as alert condition` этот блок будет отвечать за вызов уведомления.
![Программа визуализации статистики Grafana-4.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0%20%D0%B2%D0%B8%D0%B7%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20Grafana-4.png)
6.  Настройка проверки условий
	1. Для настройки надо создать папку
	2. В папке надо создать или выбрать группу. В группе устанавливается как часто будет выполняться проверка данных на вызов события `Evaluation interval`.
	3. Установить `Pending period` это время которое допускается срабатывания события без отправки уведомления. Грубо говоря задержка для перекрытия всплесков. Может быть установлено только кратно `Evaluation interval`.
	4. Для некоторых запросов важно настроить поведение когда нет данных в запросе в пункте `Alert state if no data or all values are null`  что бы избежать лишних срабатываний.
![Программа визуализации статистики Grafana-5.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0%20%D0%B2%D0%B8%D0%B7%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20Grafana-5.png)
7. Установка правил уведомления.
	1. Можно установить конкретную точку уведомления (не рекомендуется)
	2. Правильно установить метку по которой будет выполняться вызов уведомления.
![Программа визуализации статистики Grafana-6.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0%20%D0%B2%D0%B8%D0%B7%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20Grafana-6.png)
8. Задание описания и данных уведомления
	1. В основном я использую блок `Description` и там формирую [[Заметки/Работа с шаблонами Grafana Alert#Шаблоны для сообщений\|шаблонами]] уведомления для отправки.
	2. В пункте `Dashboard and panel` можно сменить привязку к конкретной панель. Эту панель можно будет вывести в сообщении и возле нее на дашборде появится значок уведомления и контроля события.
	3. Дополнительные данные можно передать через `Custom annotation` которые можно использовать в [[Заметки/Работа с шаблонами Grafana Alert#Шаблоны для сообщений\|шаблоне]].
![Программа визуализации статистики Grafana-7.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0%20%D0%B2%D0%B8%D0%B7%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20Grafana-7.png)
9. Основной этап создания события уведомления закончен.

### Настройка отправителей уведомлений:

Настройка отправки сообщений выполняется в разделе `Contact points` тут же определяются шаблоны сообщений в разделе `Notification Templates`. 

Contact Points может быть использован для любого количества правил уведомления. 

Задание шаблона сообщения выполняется в конкретной `Contact Points` в пункте `Message Template:`.

У шаблона обязательно должно быть задан заголовок в формате
```
{{ define "Уведомление о перегреве" }}
...
{{ end }}
```

При создании шаблона можно воспользоваться подбором данных уведомлений для проверки работы шаблона.
![Программа визуализации статистики Grafana-1.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0%20%D0%B2%D0%B8%D0%B7%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20Grafana-1.png)
Список будет доступен только из тех уведомлений которые активны в текущий момент времени.

### Настройка правил уведомления:

Настройка правил по которым выполняется отправка уведомлений задается в разделе `Notification policies` основное разделение выполняется по меткам установленных при создании уведомления в пункте 7.

![Программа визуализации статистики Grafana.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0%20%D0%B2%D0%B8%D0%B7%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8%20Grafana.png)
`Matching labels` - выполняет отбор уведомлений для применения правил;
`Repeat interval` - переопределяет правила повторной отправки уведомлений;
`Mute timings` - отвечает за правила когда уведомления не отправляются, правила создаются в разделе `Notification policies` -> `Mute Timings`.

Пример правил настройки событий: [[Хобби/Конфиги/Пример настроенных уведомлений для Grafana\|Пример настроенных уведомлений для Grafana]]
![[Настроенные правила уведомления.json]]

---
> [!urls]- Упоминания:
> - [[Статьи/Мониторинг домашней и серверной инфраструктуры на базе InfluxDB и Grafana\|Мониторинг домашней и серверной инфраструктуры на базе InfluxDB и Grafana]]
> - [[Статьи/Мониторинг proxmox с использованием InfluxDB v2 и Grafana\|Мониторинг proxmox с использованием InfluxDB v2 и Grafana]]
> - [[Статьи/Мониторинг роутеров openwrt в influxdb v2 и grafana\|Мониторинг роутеров openwrt в influxdb v2 и grafana]]
> - [[Статьи/Мониторинг состояния роутеров keenetic в influxdb v2 и grafanа\|Мониторинг состояния роутеров keenetic в influxdb v2 и grafanа]]
