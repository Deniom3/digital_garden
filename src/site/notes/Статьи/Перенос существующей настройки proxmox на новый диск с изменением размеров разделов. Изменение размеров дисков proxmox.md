---
{"dg-publish":true,"permalink":"/stati/perenos-sushhestvuyushhej-nastrojki-proxmox-na-novyj-disk-s-izmeneniem-razmerov-razdelov-izmenenie-razmerov-diskov-proxmox/","updated":"2024-09-23T23:49:37+03:00"}
---

Возврат:: [[Статьи/Оглавление статей\|к списку статей]] [[Статьи/Оглавление моих статей\|мои статьи]] 
> [!urls]- Заметки по статье

---
В процессе переноса системы proxmox на новый SSD большего объема я оставлю здесь краткое пошаговое руководство, которое может оказаться полезным кому-то:

Для переноса данных было использовано приложение Acronis True Image на операционной системе Windows.

!!! Внимание скриншоты сделаны пост фактум и добавлены только для общего понимания процесса, вывод будет похожим но в моем случае распределение уже было выполнено !!!

1.1. Установлен старый SSD диск в основной компьютер с Windows.

1.2. Создана резервная копия файлов со старого диска (необходимо включить все разделы, так как Windows не видит файлы настроек: Дополнительно - Режим создания - Архивирование в по секторном режиме).

![Pasted image 20240620143803.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143803.png)

1.3. Установлен новый SSD в компьютер и запущено восстановление диска с параметрами: Дополнительно - Восстановление по секторам.

![Pasted image 20240620143751.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143751.png)

![Pasted image 20240620143744.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143744.png)

2\. Установленный SSD диск был установлен в сервер, система загрузилась, используя новый SSD. Следующим шагом было расширение полученного диска для использования всего доступного пространства.

2.1. Определяем, в каком диске находятся наши данные proxmox, используя команду:

```comand
lsblk
```

В данном случае, это был диск sda и раздел sda4.

![Pasted image 20240620143720.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143720.png)

2.2. Производим расширение раздела:

```comand
fdisk /dev/sda
```

Просматриваем текущую структуру разделов с помощью команды: p.

![Pasted image 20240620143705.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143705.png)

Запоминаем начальный сектор раздела sda4, так как новый раздел должен начинаться с этого же сектора.

Удаляем раздел с помощью команды: d, указываем раздел: 4.

![Pasted image 20240620143525.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143525.png)
Создаем новый раздел с помощью команды: n. Начало нового раздела должно совпадать с начальным значением раздела, которое мы запомнили ранее. По умолчанию предлагается использовать все доступное пространство для нового раздела, с чем мы соглашаемся.

![Pasted image 20240620143515.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143515.png)
На вопрос о удалении метки отвечаем "N", но метка все равно будет повреждена.

![Pasted image 20240620143456.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143456.png)
Поэтому исправляем тип раздела 4 на Linux Filesystem с помощью команды: t с указанием типа 43.

![Pasted image 20240620143443.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143443.png)

Сохраняем изменения с помощью команды: w, для выхода без сохранения используем: q.

Перезагружаем хост:
```comand
reboot
```

Выполняем команду:

```comand
pvresize /dev/sda4
```

После этой операции размер раздела sda4 должен увеличиться.

![Pasted image 20240620143429.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143429.png)

Так же в веб интерфейсе proxmox мы должны увидеть похожу картину (!!! Обратите внимание скриншот сохранен после перераспределения в случае настройки на данном шаге у вас будет занято меньше пространства)

![Pasted image 20240620143419.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143419.png)

После этого увеличиваем размер директории local-lvm которая используется для наших виртуальных машин.

Обратите внимание pve это имя хоста оно может отличаться, его можно увидеть в том числе при выводе lsblk.

```comand
lvextend -L +350G /dev/pve/data
```

Увеличили размер на 350Gb и видим изменение в интерфейсе

![Pasted image 20240620143402.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143402.png)

Все можем использовать расширенное пространство для развертывания новых виртуальных машин.

Иногда бывает надо увеличить не только директорию local-lvm но и основную директорию local (она же root) которую использует proxmox для хранения временных файлов.

В такой ситуации команда будет выглядеть вот так:

```comand
lvextend -L +10G /dev/pve/root
```

Обязательно после изменения root директории необходимо выполнить реструктуризацию файловой системы командой

```comand
resize2fs /dev/pve/root
```

Еще один вариант задачи когда мы хотим сократить размер пула local-lvm, в таком случае безболезненно не получиться изменить.

Нам необходимо освободить пул от данных. Для этого либо надо удалить все виртуальные машины либо мигрировать их на другой диск или пул.

![Pasted image 20240620143345.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143345.png)

Для этого останавливаем виртуальную машину, и нам открывается доступ для изменения диска.

![Pasted image 20240620143330.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143330.png)

Обязательно удаляем исходный (его потом можно удалить в этом же интерфейсе после миграции)

![Pasted image 20240620143318.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143318.png)
Когда миграция закончена переходим в управления пулами.

![Pasted image 20240620143304.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143304.png)

Выбираем нужный пул и удаляем его.

![Pasted image 20240620143249.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143249.png)

После удаления у нас высвободиться пространство в LVM которое можно будет перераспределить.

Для создания нового пула перейдем в консоль и вводим команды:

```comand
lvcreate -L100G -ndata pve
lvconvert --type thin-pool --poolmetadatasize 1G pve/data
```

В данном примере создаем пул на 100G, для него обязательно инициируем метаданные из расчета 1% от пула не менее 1G.

Возвращаемся в веб морду и переходим в раздел хранилище.

![Pasted image 20240620143231.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143231.png)
Где подключаем полученный пулл к proxmox

![Pasted image 20240620143132.png](/img/user/%D0%98%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D0%B8%D0%BA%D0%B8/Pasted%20image%2020240620143132.png)

После этого можно выполнить обратную миграцию всех дисков виртуальных машин, или восстановить их из резервной копии.

Всем спасибо за внимание, надеюсь данный материал поможет.

Большая часть команд взята из материала: https://help.univention.com/t/how-to-extend-disk-space/10647 и применена в современных реалиях proxmox 8.1 с помощью чата сообщества proxmox.